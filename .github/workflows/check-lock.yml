# documentation: https://github.com/deltachat/sysadmin/tree/master/download.delta.chat
name: Check package-lock

on: 
  pull_request:
    paths-ignore:
      - "docs/**"  # only trigger build if a file outside of /docs was changed

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Use Node.js 10.x
      uses: actions/setup-node@v1
      with:
        node-version: 10.x
    - name: change build name and Product Name to development id
      run: |
        node ./bin/github-actions/devbuild.js
    - name: Checksum before build
      id: calculate
      run: |
        md5sum package-lock.json > pkgsum
        SUM=`cat pkgsum`
        echo ::set-output name=checksum::$SUM
    - name: npm install, build, test
      run: |
        npm i
    - name: "Check md5 sum"
      id: checksum
      run: |
        if ! md5sum -c pkgsum --status; then 
            echo "Warning: checksum changed"
            echo ::set-output name=warn::true
            echo "Checksum before npm i:"
            echo ${{ steps.calculate.outputs.checksum }}
            echo "Checksum after npm i:"
            cat pkgsum
        fi
    - name: "Post warning"
      if: steps.checksum.outputs.warn
      run: |
        # URLs for API connection and uploads
        export GITHUB_API_URL="https://api.github.com/repos/deltachat/deltachat-desktop/statuses/${{ github.event.after }}"
        export STATUS_DATA="{\"state\": \"failure\", \
                             \"description\": \"Remember to commit & push package-lock.json!\", \
                             \"context\": \"package-lock changed\"}"
        curl -X POST --header "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                             --url "$GITHUB_API_URL" \
                             --header "content-type: application/json" \
                             --data "$STATUS_DATA"

