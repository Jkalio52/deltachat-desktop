# documentation: https://github.com/deltachat/sysadmin/tree/master/download.delta.chat
name: Preview

on: 
  pull_request:
    paths-ignore:
      - "docs/**"  # only trigger build if a file outside of /docs was changed

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Get Pullrequest ID
      id: prepare
      run: |
        md5sum package-lock.json > pkgsum
    - name: Use Node.js 10.x
      uses: actions/setup-node@v1
      with:
        node-version: 10.x
    - name: change build name and Product Name to development id
      run: |
        node ./bin/github-actions/devbuild.js
    - name: npm install, build, test
      run: |
        npm install
        npm run build
    - name: "Post links to details"
      if: steps.prepare.outputs.uploadtoserver
      run: |
        # URLs for API connection and uploads
        export GITHUB_API_URL="https://api.github.com/repos/deltachat/deltachat-desktop/statuses/${{ github.event.after }}"
        if ! md5sum -c pkgsum --status; then 
            export STATUS_DATA="{\"state\": \"failed\", \  # this value is probably not valid
                                 \"description\": \"Remember to commit & push package-lock.json!\", \
                                 \"context\": \"package-lock changed\"}"
            curl -f -s -X POST --header "authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                               --url "$GITHUB_API_URL" \
                               --header "content-type: application/json" \
                               --data "$STATUS_DATA"
        fi

